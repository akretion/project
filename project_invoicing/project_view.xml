<?xml version="1.0" encoding="utf-8"?>
<!--
  project_invoicing for OpenERP
  Copyright (C) 2012 Akretion BenoÃ®t GUILLOT <benoit.guillot@akretion.com>
  The licence is in the file __openerp__.py
-->

<openerp>
    <data>

        <record id="account_analytic_account_form" model="ir.ui.view">
            <field name="model">account.analytic.account</field>
            <field name="inherit_id" ref="hr_timesheet_invoice.account_analytic_account_form_form"/>
            <field name="arch" type="xml">
                <xpath expr='//field[@name="to_invoice"]' position='after'>
                    <!-- TODO only allow unit with the same categ as the company_uom_id-->
                    <field name="invoice_uom_id"/>
                </xpath>
            </field>
        </record>

        <!--INHERITED VIEW FOR THE OBJECT : project_task -->

        <record id="view_task_form2" model="ir.ui.view">
            <field name="model">project.task</field>
            <field name="inherit_id" ref="timesheet_task.view_task_form2" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='progress']" position="after">
                    <field name="invoicing_type" />
                </xpath>
            </field>
        </record>

        <record id="hr_timesheet_sheet_form_with_activity" model="ir.ui.view">
            <field name="name">hr.timesheet.sheet.form</field>
            <field name="model">hr_timesheet_sheet.sheet</field>
            <field name="inherit_id" ref="hr_timesheet_task.hr_timesheet_sheet_form_with_activity"/>
            <field name="arch" type="xml">
                <field name="task_id" position="attributes">
                    <attribute name="on_change">on_change_task_id(account_id, task_id)</attribute>
                </field>
            </field>
        </record>

        <record id="view_task_to_invoice_filter" model="ir.ui.view">
            <field name="name">project_invoice.project_task.to_invoice</field>
            <field name="model">project.task</field>
            <field name="arch" type="xml">
                <search string="Search Task to Invoice">
                    <field name="name" string="Tasks"/>
                    <filter icon="terp-mail-message-new" string="Unread Messages" name="message_unread" domain="[('message_unread','=',True)]"/>
                    <separator/>
                    <filter name="draft" string="New" domain="[('state','=','draft')]" help="New Tasks" icon="terp-check"/>
                    <filter name="open" string="In Progress" domain="[('state','=','open')]" help="In Progress Tasks" icon="terp-camera_test"/>
                    <filter string="Pending" domain="[('state','=','pending')]" context="{'show_delegated':False}" help="Pending Tasks" icon="terp-gtk-media-pause"/>
                    <separator/>
                    <filter name="My project" string="Project" domain="[('project_id.user_id','=',uid)]" help="My Projects" icon="terp-check"/>
                    <separator/>
                    <filter string="My Tasks" domain="[('user_id','=',uid)]"  help="My Tasks" icon="terp-personal"/>
                    <filter string="Unassigned Tasks" domain="[('user_id','=',False)]"  help="Unassigned Tasks" icon="terp-personal-"/>
                    <separator/>
                    <filter string="Deadlines" context="{'deadline_visible': False}" domain="[('date_deadline','&lt;&gt;',False)]"
                        help="Show only tasks having a deadline" icon="terp-gnome-cpu-frequency-applet+"/>
                    <field name="project_id"/>
                    <field name="user_id"/>
                    <group expand="0" string="Group By...">
                        <filter string="Users" name="group_user_id" icon="terp-personal" domain="[]"  context="{'group_by':'user_id'}"/>
                        <filter string="Project" name="group_project_id" icon="terp-folder-violet" domain="[]" context="{'group_by':'project_id'}"/>
                        <filter string="Stage" name="group_stage_id" icon="terp-stage" domain="[]" context="{'group_by':'stage_id'}"/>
                        <filter string="Deadline" icon="terp-gnome-cpu-frequency-applet+" domain="[]" context="{'group_by':'date_deadline'}"/>
                        <filter string="Start Date" icon="terp-go-month" domain="[]" context="{'group_by':'date_start'}" groups="base.group_no_one"/>
                        <filter string="End Date" icon="terp-go-month" domain="[]" context="{'group_by':'date_end'}" groups="base.group_no_one"/>
                    </group>
                </search>
            </field>
        </record>

    <!-- Menus -->
        <record id="action_task_to_invoice_open_tree" model="ir.actions.act_window">
            <field name="name">Invoice Tasks</field>
            <field name="res_model">project.task</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('state', '=', 'done'), ('invoicing_type', '=', 'fixed_amount'), ('invoice_line_ids', '=', False)]</field>
            <field name="context">{}</field>
            <field name="search_view_id" ref="view_task_to_invoice_filter"/>            
            <field name="help" type="html">
              <p class="oe_view_nocontent_create">
                Click to add some tasks to be invoiced.
              </p><p>
                This list shows every task you can invoice to the customer.
                Select the lines and invoice from the '<i>more...</i>' contextual
                menu to generate invoices automatically.
              </p>
            </field>
        </record>

        <menuitem
            id="menu_invoicing"
            parent="base.menu_main_pm"
            name="Invoicing"
            sequence="20"/>

        <menuitem
            action="action_task_to_invoice_open_tree"
            id="menu_task_to_invoice_tree"
            parent="menu_invoicing"
            sequence="10"/>
        
        <record id="action_hr_analytic_timesheet_open_tree" model="ir.actions.act_window">
            <field name="name">Invoice Tasks Work</field>
            <field name="res_model">hr.analytic.timesheet</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="domain"></field>
            <field name="context">{'search_default_to_invoice': 1}</field>
            <field name="search_view_id" ref="hr_timesheet_task.hr_timesheet_line_search"/>            
            <field name="help" type="html">
              <p class="oe_view_nocontent_create">
                Click to add some tasks work to be invoiced.
              </p><p>
                This list shows every task you can invoice to the customer.
                Select the lines and invoice from the '<i>more...</i>' contextual
                menu to generate invoices automatically.
              </p>
            </field>
        </record>
        
        <menuitem
            action="action_hr_analytic_timesheet_open_tree"
            id="menu_hr_analytic_timesheet_tree"
            parent="menu_invoicing"
            sequence="20"/>

    </data>
</openerp>
